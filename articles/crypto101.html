<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="sodium">
<title>How does cryptography work? • sodium</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How does cryptography work?">
<meta property="og:description" content="sodium">
<meta property="og:image" content="https://docs.ropensci.org/sodium/logo.png">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">sodium</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.3.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/crypto101.html">How does cryptography work?</a>
    <a class="dropdown-item" href="../articles/intro.html">Sodium: A Modern and Easy-to-Use Crypto Library</a>
  </div>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/sodium/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>How does cryptography work?</h1>
            
            <h4 data-toc-skip class="date">2024-03-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/sodium/blob/HEAD/vignettes/crypto101.rmd" class="external-link"><code>vignettes/crypto101.rmd</code></a></small>
      <div class="d-none name"><code>crypto101.rmd</code></div>
    </div>

    
    
<p>This page attempts to give a very basic conceptual introduction to cryptographic methods. Before we start the usual disclaimer:</p>
<p><strong><em>I am not a cryptographer. This document is only for educational purposes. Crypto is hard, you should never trust your home-grown implementation. Unless you’re a cryptographer you will probably overlook some crucial details. Developers should only use the high-level functions that have been implemented by an actual cryptographer.</em></strong></p>
<p>Now that we got this is out of the way, let’s start hacking :)</p>
<div class="section level3">
<h3 id="the-xor-operator">The XOR operator<a class="anchor" aria-label="anchor" href="#the-xor-operator"></a>
</h3>
<p>The bitwise <a href="https://en.wikipedia.org/wiki/Exclusive_or#Truth_table" class="external-link">XOR operator</a> outputs <code>true</code> only when both inputs differ (one is <code>true</code>, the other is <code>false</code>). It is sometimes called an <em>invertor</em> because the output of a bit in <code>x</code> gets inverted if and only if the corresponding bit in <code>y</code> is true:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># XOR two (8bit) bytes 'x' and 'y'</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/raw.html" class="external-link">as.raw</a></span><span class="op">(</span><span class="fl">0x7a</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/raw.html" class="external-link">as.raw</a></span><span class="op">(</span><span class="fl">0xe4</span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">xor</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dput.html" class="external-link">dput</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/base/raw.html" class="external-link">as.raw</a></span><span class="op">(</span><span class="fl">0x9e</span><span class="op">)</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show the bits in each byte</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToBits</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToBits</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToBits</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>      x  y  z
[1,] 00 00 00
[2,] 01 00 01
[3,] 00 01 01
[4,] 01 00 01
[5,] 01 00 01
[6,] 01 01 00
[7,] 01 01 00
[8,] 00 01 01</code></pre>
<p>In cryptography we <code>xor</code> a message <code>x</code> with secret random data <code>y</code>. Because each bit in <code>y</code> is randomly <code>true</code> with probability 0.5, the <code>xor</code> output is completely random and uncorrelated to <code>x</code>. This is called <em>perfect secrecy</em>. Only if we know <code>y</code> we can decipher the message <code>x</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Encrypt message using random one-time-pad</span></span>
<span><span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">charToRaw</a></span><span class="op">(</span><span class="st">"TTIP is evil"</span><span class="op">)</span></span>
<span><span class="va">one_time_pad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/helpers.html">random</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">msg</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ciphertext</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">xor</a></span><span class="op">(</span><span class="va">msg</span>, <span class="va">one_time_pad</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># It's really encrypted</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToChar</a></span><span class="op">(</span><span class="va">ciphertext</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "P@\016\xdd\xe9\xe7\032g?=\xaa\021"</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Decrypt with same pad</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToChar</a></span><span class="op">(</span><span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">xor</a></span><span class="op">(</span><span class="va">ciphertext</span>, <span class="va">one_time_pad</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "TTIP is evil"</code></pre>
<p>This method is perfectly secure and forms the basis for most cryptograhpic methods. However the challenge is generating and communicating unique pseudo-random <code>y</code> data every time we want to encrypt something. One-time-pads as in the example are not very practical for large messages. Also we should never re-use a one-time-pad <code>y</code> for encrypting multiple messages, as this compromises the secrecy.</p>
</div>
<div class="section level3">
<h3 id="stream-ciphers">Stream ciphers<a class="anchor" aria-label="anchor" href="#stream-ciphers"></a>
</h3>
<p>The solution to this problem are stream ciphers. A <em>stream cipher</em> generates a unique stream of pseudo-random data based on a secret <code>key</code> and a unique <code>nonce</code>. For a given set of parameters the stream cipher always generates the same stream of data. Sodium implements a few popular stream ciphers:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">password</span> <span class="op">&lt;-</span> <span class="st">"My secret passphrase"</span></span>
<span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hash.html">hash</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">charToRaw</a></span><span class="op">(</span><span class="va">password</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nonce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/helpers.html">random</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/stream.html">chacha20</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span>, <span class="va">key</span>, <span class="va">nonce</span><span class="op">)</span></span></code></pre></div>
<pre><code> [1] 9f d1 10 3c 51 52 79 5e 43 1e d6 41 06 ae 06 7e f3 6f 80 ae</code></pre>
<p>Each stream requires a <code>key</code> and a <code>nonce</code>. The key forms the shared secret and should only be known to trusted parties. The <code>nonce</code> is not secret and is stored or sent along with the ciphertext. The purpose of the <code>nonce</code> is to make a random stream unique to protect gainst re-use attacks. This way you can re-use a your key to encrypt multiple messages, as long as you never re-use the same nonce.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/stream.html">salsa20</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span>, <span class="va">key</span>, <span class="va">nonce</span><span class="op">)</span></span></code></pre></div>
<pre><code> [1] d7 26 a7 98 ec d0 56 97 54 f7 e8 92 29 84 ed aa 25 d6 28 93</code></pre>
<p>Over the years cryptographers have come up with many more variants. Many stream ciphers are based on a block cipher such as <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard" class="external-link">AES</a>: a keyed permutation of fixed length amount of data. The block ciphers get chained in a particular <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation" class="external-link">mode of operation</a> which repeatedly applies the cipher’s single-block operation to securely transform amounts of data larger than a block.</p>
<p>We are not going to discuss implementation details, but you could probably come up with something yourself. For example you could use a hash function such <code>sha256</code> as the block cipher and append counter which is incremented for each block (this is called CTR mode).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Illustrative example.</span></span>
<span><span class="va">sha256_ctr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">size</span>, <span class="va">key</span>, <span class="va">nonce</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">size</span><span class="op">/</span><span class="fl">32</span><span class="op">)</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/raw.html" class="external-link">raw</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">counter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">packBits</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">intToBits</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">block</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hash.html">sha256</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">key</span>, <span class="va">nonce</span>, <span class="va">counter</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">output</span>, <span class="va">block</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">output</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">size</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This allows us to generate an arbitrary length stream from a single secret key:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">password</span> <span class="op">&lt;-</span> <span class="st">"My secret passphrase"</span></span>
<span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hash.html">hash</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">charToRaw</a></span><span class="op">(</span><span class="va">password</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nonce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/helpers.html">random</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu">sha256_ctr</span><span class="op">(</span><span class="fl">50</span>, <span class="va">key</span>, <span class="va">nonce</span><span class="op">)</span></span></code></pre></div>
<pre><code> [1] a3 9a e2 79 11 b1 17 b6 e8 ac a3 d2 10 99 1b 55 9b fc 50 aa a0 ac e0 05 1f
[26] f7 c4 91 b3 da e5 bd e6 1e 79 24 1f 25 61 d9 d1 98 95 43 53 00 15 96 73 15</code></pre>
<p>In practice, you should never write your own ciphers. A lot of <a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.58.1811&amp;rep=rep1&amp;type=pdf" class="external-link">research</a> goes into studying the properties of block ciphers under various modes of operation. In the remainder we just use the standard Sodium ciphers: <a href="https://libsodium.gitbook.io/doc/advanced/stream_ciphers/chacha20" class="external-link"><code>chacha20</code></a>, <a href="https://libsodium.gitbook.io/doc/advanced/stream_ciphers/salsa20" class="external-link"><code>salsa20</code></a> or <a href="https://libsodium.gitbook.io/doc/advanced/stream_ciphers/xsalsa20" class="external-link"><code>xsalsa20</code></a>.</p>
</div>
<div class="section level3">
<h3 id="symmetric-encryption">Symmetric encryption<a class="anchor" aria-label="anchor" href="#symmetric-encryption"></a>
</h3>
<p>Symmetric encryption means that the same secret key is used for both encryption and decryption. All that is needed to implement symmetric encryption is <code>xor</code> and a stream cipher. For example to encrypt an arbitrary length <code>message</code> using <code>password</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Encrypt 'message' using 'password'</span></span>
<span><span class="va">myfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Rhome.html" class="external-link">R.home</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"COPYING"</span><span class="op">)</span></span>
<span><span class="va">message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readBin.html" class="external-link">readBin</a></span><span class="op">(</span><span class="va">myfile</span>, <span class="fu"><a href="https://rdrr.io/r/base/raw.html" class="external-link">raw</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="va">myfile</span><span class="op">)</span><span class="op">$</span><span class="va">size</span><span class="op">)</span></span>
<span><span class="va">passwd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">charToRaw</a></span><span class="op">(</span><span class="st">"My secret passphrase"</span><span class="op">)</span></span></code></pre></div>
<p>A hash function converts the password to a key of suitable size for the stream cipher, which we use to generate a psuedo random stream of equal length to the message:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Basic secret key encryption</span></span>
<span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hash.html">hash</a></span><span class="op">(</span><span class="va">passwd</span><span class="op">)</span></span>
<span><span class="va">nonce8</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/helpers.html">random</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stream.html">chacha20</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">message</span><span class="op">)</span>, <span class="va">key</span>, <span class="va">nonce8</span><span class="op">)</span></span>
<span><span class="va">ciphertext</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">xor</a></span><span class="op">(</span><span class="va">stream</span>, <span class="va">message</span><span class="op">)</span></span></code></pre></div>
<p>Now the <code>ciphertext</code> is an encrypted version of the message. Only those that know the <code>key</code> and the <code>nonce</code> can re-generate the same keystream in order to <code>xor</code> the ciphertext back into the original message.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Decrypt with the same key</span></span>
<span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hash.html">hash</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">charToRaw</a></span><span class="op">(</span><span class="st">"My secret passphrase"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stream.html">chacha20</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ciphertext</span><span class="op">)</span>, <span class="va">key</span>, <span class="va">nonce8</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">xor</a></span><span class="op">(</span><span class="va">ciphertext</span>, <span class="va">stream</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print part of the message</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToChar</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">120</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>                    GNU GENERAL PUBLIC LICENSE
                       Version 2, June 1991

 Copyright (C) 1989, 1991 Fr</code></pre>
<p>The Sodium functions <code>data_encrypt</code> and <code>data_decrypt</code> provide a more elaborate implementation of the above. This is what you should use in practice for secret key encryption.</p>
<p>Symmetric encryption can be used for e.g. encrypting local data. However because the same secret is used for both encryption and decryption, it is impractical for communication with other parties. For exchanging secure messages we need public key encryption.</p>
</div>
<div class="section level3">
<h3 id="public-key-encryption-and-diffie-hellman">Public-key encryption and Diffie-Hellman<a class="anchor" aria-label="anchor" href="#public-key-encryption-and-diffie-hellman"></a>
</h3>
<p>Rather than using a single secret-key, assymetric (public key) encryption requires a <em>keypair</em>, consisting of a <em>public key</em> for encryption and a <em>private-key</em> for decryption. Data that is encrypted using a given public key can only be decrypted using the corresponding private key.</p>
<p>The public key is not confidential and can be shared on e.g. a website or keyserver. This allows anyone to send somebody a secure message by encrypting it with the receivers public key. The encrypted message will only be readable by the owner of the corresponding private key.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create keypair</span></span>
<span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keygen.html">keygen</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pub</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keygen.html">pubkey</a></span><span class="op">(</span><span class="va">key</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Encrypt message for receiver using his/her public key</span></span>
<span><span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize</a></span><span class="op">(</span><span class="va">iris</span>, <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">ciphertext</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simple.html">simple_encrypt</a></span><span class="op">(</span><span class="va">msg</span>, <span class="va">pub</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Receiver decrypts with his/her private key</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simple.html">simple_decrypt</a></span><span class="op">(</span><span class="va">ciphertext</span>, <span class="va">key</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">msg</span>, <span class="va">out</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] TRUE</code></pre>
<p>How does this work? Public key encryption makes use of Diffie-Hellman (D-H): a method which allows two parties that have no prior knowledge of each other to jointly establish a shared secret key over an insecure channel. In the most simple case, both parties generate a temporary keypair and exchange their public key over the insecure channel. Then both parties use the D-H function to calculcate the (same) shared secret key by combining their own private key with the other person’s public key:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bob generates keypair</span></span>
<span><span class="va">bob_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keygen.html">keygen</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bob_pubkey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keygen.html">pubkey</a></span><span class="op">(</span><span class="va">bob_key</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Alice generates keypair</span></span>
<span><span class="va">alice_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keygen.html">keygen</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">alice_pubkey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keygen.html">pubkey</a></span><span class="op">(</span><span class="va">alice_key</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># After Bob and Alice exchange pubkey they can both derive the secret</span></span>
<span><span class="va">alice_secret</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/diffie.html">diffie_hellman</a></span><span class="op">(</span><span class="va">alice_key</span>, <span class="va">bob_pubkey</span><span class="op">)</span></span>
<span><span class="va">bob_secret</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/diffie.html">diffie_hellman</a></span><span class="op">(</span><span class="va">bob_key</span>, <span class="va">alice_pubkey</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">alice_secret</span>, <span class="va">bob_secret</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] TRUE</code></pre>
<p>Once the shared secret has been established, both parties can discard their temporary public/private key and use the shared secret to start encrypting communications with symmetric encryption as discussed earlier. Because the shared secret cannot be calculated using only the public keys, the process is safe from eavesdroppers.</p>
<p>The classical Diffie-Hellman method is based on the discrete logarithm problem with large prime numbers. Sodium uses <a href="https://cr.yp.to/ecdh/curve25519-20060209.pdf" class="external-link">curve25519</a>, a state-of-the-art D-H function by Daniel Bernsteinan designed for use with the elliptic curve Diffie–Hellman (ECDH) key agreement scheme.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
